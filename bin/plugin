#/bin/bash
set -eu
source "$(cd "$(dirname "$0")"; pwd)/vars.sh"

# clear destination
rm -rf "$INSTALL_DIR/share/emacs/$VERSION/site-lisp"
mkdir -p "$INSTALL_DIR/share/emacs/$VERSION/site-lisp"

# copy only .el files
cd "$ROOT/lisp"
find -name "*.el" | xargs -I{} cp -v --parents {} "$INSTALL_DIR/share/emacs/$VERSION/site-lisp/"

# byte compile
cd "$INSTALL_DIR/share/emacs/$VERSION/site-lisp"
find -name "*.el" | grep -v "default.el" \
                  | grep -v "subdirs.el" \
                  | xargs "$INSTALL_DIR/bin/emacs" --batch -f batch-byte-compile

